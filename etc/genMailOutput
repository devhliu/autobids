#!/bin/bash
if [ "$#" -lt 2 ]
then

echo "Usage: $0 <BIDS_dir> <endpoint UUID>"
exit 1

fi

bids=$1
endpoint=$2

if [ ! -e $bids ]
then
	exit 1
fi
#strip of trailing /
bids=${bids%/}

admin=switt4@uwo.ca

url="https://app.globus.org/file-manager?origin_id=$endpoint&origin_path=%2F"

validator_txt=`ls -1t $bids/code/*/bids-validator.txt | head -n 1`
subjects_txt=`ls -1t $bids/code/*/subjects-list.txt | head -n 1`

if [ ! -e $validator_txt -o ! -e $subjects_txt ] 
then
  exit 1
fi

echo "BIDS conversion for ${bids##*/} completed for the following participants:"
for subj in `cat $subjects_txt `
do
	echo "	$subj"
done
echo ""
echo ""
echo " Use the following link to access the files via globus:"
echo "	$url"
echo ""
echo ""
echo "BIDS validator output (abbreviated):"
cat $validator_txt | sed 's/\x1b\[[0-9;]*m//g'  #use sed to remove ascii terminal colors from the text (mail treats this as a binary file if not)
echo ""
echo ""
echo "This message was generated by autobids running on the Compute Canada's Graham cluster."
echo "To remove further e-mail notifications, please contact $admin"
echo ""
echo "For more information on autobids, please see https://github.com/khanlab/autobids"


