#!/bin/bash
if [ "$#" -lt 3 ]
then

echo "Usage: $0 <e-mail address> <BIDS_dir> <endpoint UUID>"
exit 1

fi

email=$1
bids=$2
endpoint=$3

admin=alik@robarts.ca

url="https://www.globus.org/app/transfer?origin_id=$endpoint&origin_path=%2F"

validator_txt=`ls -1t $bids/code/*/bids-validator.txt | head -n 1`
subjects_txt=`ls -1t $bids/code/*/subjects-list.txt | head -n 1`

maildir=$AUTOBIDS_DIR/var/mail
datestring=`date +%Y-%m-%d_%Hh_%Mm`
body=$maildir/$datestring.${bids##*/}.txt

echo "BIDS conversion for ${bids##*/} completed for the following participants:" > $body
for subj in `cat $subjects_txt `
do
	echo "	$subj" >> $body
done
echo "" >> $body
echo "" >> $body
echo " Use the following link to access the files via globus:" >> $body
echo "	$url" >> $body
echo "" >> $body
echo "" >> $body
echo "BIDS validator output (abbreviated):" >> $body
cat $validator_txt | sed 's/\x1b\[[0-9;]*m//g'  >> $body #use sed to remove ascii terminal colors from the text (mail treats this as a binary file if not)
echo "" >> $body
echo "" >> $body
echo "This message was generated by autobids running on the Compute Canada's Graham cluster." >> $body
echo "To remove further e-mail notifications, please contact $admin" >> $body
echo "" >> $body
echo "For more information on autobids, please see https://github.com/khanlab/autobids" >> $body


#deal with comma-separated e-mails
i=1
for addr in $(echo $email  | sed "s/,/ /g")
do
cat $body | mail -s "autobids-cfmm: ${bids##*/} import complete" $addr
if [ "$i" -gt 1 ]
then
sleep 30 # to avoid sending mail too quickly..
fi
i=$((i+1))
done


